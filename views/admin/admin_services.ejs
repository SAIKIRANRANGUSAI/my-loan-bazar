<%- include('../layouts/admin_layouts_header', { title: 'Admin | Services', currentPage: 'services' }) %>
<%- include('../layouts/admin_layouts_sidebar', { currentPage: 'services' }) %>

<div class="main-content container-fluid py-4">

  <!-- Services Page Content -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Services Page Content</h5>
    </div>
    <div class="card-body">
      <form id="updateContentForm">
        <div class="mb-3">
          <label class="form-label">Heading</label>
          <textarea name="heading" class="form-control ckeditor"><%= content.heading %></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control ckeditor"><%= content.description %></textarea>
        </div>
        <button type="submit" class="btn btn-success">Update Page Content</button>
      </form>
    </div>
  </div>

  <!-- Services List -->
  <div class="card shadow-sm">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">All Services</h5>
      <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addServiceModal">
        + Add New Service
      </button>
    </div>
    <div class="card-body">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Icon</th>
            <th>Heading</th>
            <th>Sub Heading</th>
            <th>Short Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (services.length > 0) { %>
            <% services.forEach(service => { %>
              <tr>
                <td><img src="<%= service.icon_image %>" alt="" style="width:50px;height:50px;object-fit:contain;"></td>
                <td><%= service.heading %></td>
                <td><%= service.sub_heading %></td>
                <td><%= service.short_description %></td>
                <td>
                  <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editServiceModal<%= service.id %>">Edit</button>
                  <button class="btn btn-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#faq<%= service.id %>">FAQs</button>
                  <button class="btn btn-danger btn-sm deleteServiceBtn" data-id="<%= service.id %>">Delete</button>
                </td>
              </tr>

              <!-- FAQ Section -->
              <tr class="collapse" id="faq<%= service.id %>">
                <td colspan="5">
                  <div class="mb-3">
                    <h6>FAQs</h6>
                    <form class="faqAddForm row g-2" data-service="<%= service.id %>">
                      <input type="hidden" name="service_id" value="<%= service.id %>">
                      <div class="col-md-5">
                        <input type="text" name="question" class="form-control" placeholder="Question" required>
                      </div>
                      <div class="col-md-5">
                        <input type="text" name="answer" class="form-control" placeholder="Answer" required>
                      </div>
                      <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Add FAQ</button>
                      </div>
                    </form>

                    <% if (service.faqs && service.faqs.length > 0) { %>
                      <ul class="list-group mt-2 faqList<%= service.id %>">
                        <% service.faqs.forEach(faq => { %>
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div><strong>Q:</strong> <%= faq.question %> | <strong>A:</strong> <%= faq.answer %></div>
                            <div>
                              <button class="btn btn-sm btn-outline-warning editFaqBtn" data-id="<%= faq.id %>" data-question="<%= faq.question %>" data-answer="<%= faq.answer %>">Edit</button>
                              <button class="btn btn-sm btn-outline-danger deleteFaqBtn" data-id="<%= faq.id %>">Delete</button>
                            </div>
                          </li>
                        <% }) %>
                      </ul>
                    <% } %>
                  </div>
                </td>
              </tr>

              <!-- Edit Service Modal -->
              <div class="modal fade" id="editServiceModal<%= service.id %>" tabindex="-1">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                      <h5 class="modal-title">Edit Service</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form class="editServiceForm" data-id="<%= service.id %>" enctype="multipart/form-data">
                      <div class="modal-body">
                        <input type="hidden" name="old_icon_image" value="<%= service.icon_image %>">
                        <input type="hidden" name="old_image_1" value="<%= service.image_1 %>">
                        <input type="hidden" name="old_image_2" value="<%= service.image_2 %>">
                        <div class="row g-3">
                          <div class="col-md-6">
                            <label>Heading</label>
                            <input type="text" name="heading" class="form-control" value="<%= service.heading %>" required>
                          </div>
                          <div class="col-md-6">
                            <label>Sub Heading</label>
                            <input type="text" name="sub_heading" class="form-control" value="<%= service.sub_heading %>">
                          </div>
                          <div class="col-md-6">
                            <label>Short Description</label>
                            <textarea name="short_description" class="form-control"><%= service.short_description %></textarea>
                          </div>
                          <div class="col-md-6">
                            <label>Icon Image</label>
                            <input type="file" name="icon_image" class="form-control" accept="image/*">
                            <img src="<%= service.icon_image %>" class="mt-1" style="width:50px;height:50px;object-fit:contain;">
                          </div>
                          <div class="col-md-6">
                            <label>Image 1</label>
                            <input type="file" name="image_1" class="form-control" accept="image/*">
                            <% if(service.image_1){ %>
                              <img src="<%= service.image_1 %>" class="mt-1" style="width:50px;height:50px;object-fit:contain;">
                            <% } %>
                          </div>
                          <div class="col-md-6">
                            <label>Image 2</label>
                            <input type="file" name="image_2" class="form-control" accept="image/*">
                            <% if(service.image_2){ %>
                              <img src="<%= service.image_2 %>" class="mt-1" style="width:50px;height:50px;object-fit:contain;">
                            <% } %>
                          </div>
                          <div class="col-12">
                            <label>Description</label>
                            <textarea name="description" class="form-control ckeditor"><%= service.description %></textarea>
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Save Changes</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

            <% }) %>
          <% } else { %>
            <tr><td colspan="5" class="text-center">No Services Found</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Add Service Modal -->
<div class="modal fade" id="addServiceModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Add New Service</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="addServiceForm" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label>Heading</label>
              <input type="text" name="heading" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label>Sub Heading</label>
              <input type="text" name="sub_heading" class="form-control">
            </div>
            <div class="col-md-6">
              <label>Short Description</label>
              <textarea name="short_description" class="form-control"></textarea>
            </div>
            <div class="col-md-6">
              <label>Icon Image</label>
              <input type="file" name="icon_image" class="form-control" accept="image/*" required>
            </div>
            <div class="col-md-6">
              <label>Image 1</label>
              <input type="file" name="image_1" class="form-control" accept="image/*">
            </div>
            <div class="col-md-6">
              <label>Image 2</label>
              <input type="file" name="image_2" class="form-control" accept="image/*">
            </div>
            <div class="col-12">
              <label>Description</label>
              <textarea name="description" class="form-control ckeditor"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Add Service</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".ckeditor").forEach(el => CKEDITOR.replace(el));

  // Add Service
  document.getElementById("addServiceForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    let form = new FormData(e.target);
    const res = await fetch("/admin/services/add", { method: "POST", body: form });
    const data = await res.json();
    Swal.fire(data.success ? 'Success' : 'Error', data.message, data.success ? 'success' : 'error')
      .then(() => { if(data.success) location.reload(); });
  });

  // Edit Service
  document.querySelectorAll(".editServiceForm").forEach(form => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      let id = form.dataset.id;
      let formData = new FormData(form);
      const res = await fetch("/admin/services/edit/" + id, { method: "POST", body: formData });
      const data = await res.json();
      Swal.fire(data.success ? 'Success' : 'Error', data.message, data.success ? 'success' : 'error')
        .then(() => { if(data.success) location.reload(); });
    });
  });

  // Delete Service
  document.querySelectorAll(".deleteServiceBtn").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      let id = btn.dataset.id;
      Swal.fire({
        title: 'Are you sure?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!'
      }).then(async (result) => {
        if(result.isConfirmed){
          const res = await fetch("/admin/services/delete/" + id);
          const data = await res.json();
          Swal.fire(data.success ? 'Deleted' : 'Error', data.message, data.success ? 'success' : 'error')
            .then(() => { if(data.success) location.reload(); });
        }
      });
    });
  });

  // Add FAQ
  document.querySelectorAll(".faqAddForm").forEach(form => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      let formData = new FormData(form);
      const res = await fetch("/admin/services/faq/add", { method: "POST", body: formData });
      const data = await res.json();
      Swal.fire(data.success ? 'Success' : 'Error', data.message, data.success ? 'success' : 'error')
        .then(() => { if(data.success) location.reload(); });
    });
  });

  // TODO: Add Edit FAQ modal + Delete FAQ SweetAlert
});
</script>

<%- include('../layouts/admin_layouts_footer') %>
